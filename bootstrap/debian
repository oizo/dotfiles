#!/usr/bin/env bash

# Exit on error, undefined variables, and pipe failures
set -euo pipefail

###############################################################################
# Script Initialization                                                       #
###############################################################################

# Detect architecture "32" or "64"
ARCH=$(uname -m | sed 's/x86_//;s/i[3-6]86/32/')
# Set an architecture boolean
IS_X64=$(( ${ARCH} == "64" ))

# Simple function for downloading and installing a deb package
function download_and_install() {
    # Download the artifact
    wget -O pkg.deb "$1"
    # Install the package
    yes | sudo dpkg -i pkg.deb
    # Resolve dependencies
    sudo apt-get -f install -y
    # Remove the artifact
    rm pkg.deb
}

###############################################################################
# Install regulare packages and PPAs                                         #
###############################################################################

# Ensure that we have the necessary tools for setting up new PPAs
sudo apt-get install -y software-properties-common

# Auto accept the mscorefonts eula (during apt-get installation)
echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections

# Update the package list
sudo apt-get update

# List of apt packages to get
PACKAGES=(
    ffmpeg
    git
    git-lfs
    gnupg
    imagemagick
    jq
    markdown
    npm
    python3
    python3-dev
    python-is-python3
    build-essential
    ruby
    rubygems-integration
    openssh-client
    openssh-server
    synaptic
    whois
    rar
    htop
    curl
    geeqie
    chromium
    openjdk-8-jdk
    openjdk-8-jre
    openjdk-11-jdk
    openjdk-11-jre
    firefox
    vlc
    gimp
    filezilla
    keepassxc
    qbittorrent
    virtualbox
    virtualbox-qt
    virtualbox-guest-additions-iso
    git-cola
    unrar-free
    p7zip-full
    xdotool
)

echo "Append distribution specific apt packages"
if [ "$DISTRIBUTION" == "ubuntu" ]; then
    UBUNTU_PACKAGES=(
        nautilus-dropbox
        ubuntu-restricted-extras
    )
    PACKAGES=("${PACKAGES[@]}" "${UBUNTU_PACKAGES[@]}")
elif [ "$DISTRIBUTION" == "linuxmint" ]; then
    # Enable 32-bit architecture support for multiarch
    sudo dpkg --add-architecture i386
    
    MINT_PACKAGES=(
        libc6:i386
        libstdc++6:i386
        nemo-dropbox
    )
    PACKAGES=("${PACKAGES[@]}" "${MINT_PACKAGES[@]}")
fi

echo "Installing packages... ${PACKAGES[@]}"
sudo apt-get install -y ${PACKAGES[@]}

echo "Cleaning up..."
sudo apt-get clean

###############################################################################
# Install additional packages and applications                               #
###############################################################################

echo "Installing Sublime text..."
wget -qO - https://download.sublimetext.com/sublimehq-pub.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/sublimehq-archive.gpg > /dev/null
echo "deb https://download.sublimetext.com/ apt/stable/" | sudo tee /etc/apt/sources.list.d/sublime-text.list > /dev/null
sudo apt-get update
sudo apt-get install -y sublime-text

echo "Installing IntelliJ IDEA Community..."
sudo rm -rf /opt/idea-IC-*
wget -O idea.tar.gz "https://data.services.jetbrains.com/products/download?platform=linux&code=IIC"
sudo tar -xzf idea.tar.gz -C /opt/
sudo ln -sf /opt/idea-IC-*/bin/idea.sh /usr/local/bin/idea
rm idea.tar.gz

echo "Installing TeamViewer..."
wget -qO - https://download.teamviewer.com/download/linux/signature/TeamViewer2017.asc | sudo gpg --dearmor --yes -o /usr/share/keyrings/teamviewer-keyring.gpg
echo "deb [arch=amd64,i386 signed-by=/usr/share/keyrings/teamviewer-keyring.gpg] https://linux.teamviewer.com/deb stable main" | sudo tee /etc/apt/sources.list.d/teamviewer.list > /dev/null
sudo apt-get update
sudo apt-get install -y teamviewer

echo "Installing FileBot..."
curl -fsSL "https://raw.githubusercontent.com/filebot/plugins/master/gpg/maintainer.pub" | sudo gpg --dearmor --output "/usr/share/keyrings/filebot.gpg"
echo "deb [arch=all signed-by=/usr/share/keyrings/filebot.gpg] https://get.filebot.net/deb/ universal main" | sudo tee "/etc/apt/sources.list.d/filebot.list" > /dev/null
sudo apt-get update
sudo apt-get install -y --install-recommends default-jre openjfx zenity mediainfo libchromaprint-tools p7zip-full unrar filebot

echo "Installing Signal..."
wget -O- https://updates.signal.org/desktop/apt/keys.asc | gpg --dearmor > signal-desktop-keyring.gpg
cat signal-desktop-keyring.gpg | sudo tee /usr/share/keyrings/signal-desktop-keyring.gpg > /dev/null
echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/signal-desktop-keyring.gpg] https://updates.signal.org/desktop/apt xenial main' | sudo tee /etc/apt/sources.list.d/signal-xenial.list > /dev/null
rm signal-desktop-keyring.gpg
sudo apt update && sudo apt install -y signal-desktop

echo "Installing Telegram..."
wget -O telegram.tar.xz https://telegram.org/dl/desktop/linux
tar xf telegram.tar.xz
sudo rm -rf /opt/telegram
sudo mv Telegram /opt/telegram
sudo ln -sf /opt/telegram/Telegram /usr/bin/telegram
rm telegram.tar.xz

echo "Installing VSCode..."
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | sudo tee /usr/share/keyrings/packages.microsoft.gpg > /dev/null
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" | sudo tee /etc/apt/sources.list.d/vscode.list > /dev/null
sudo apt update
sudo apt install code -y

# Add Synology Drive Client to downloads
# Parse this link, and take the first link:
# https://archive.synology.com/download/Utility/SynologyDriveClient

# Add filezilla to downloads
# filezilla


# Device udev rules
sudo curl --create-dirs -L -o /etc/udev/rules.d/51-android.rules https://raw.githubusercontent.com/snowdream/51-android/master/51-android.rules
sudo chmod a+r /etc/udev/rules.d/51-android.rules
sudo service udev restart

# Configure ThinkPad fan control (only on ThinkPads)
if sudo dmidecode -s system-product-name | grep -qi "thinkpad"; then
    echo "ThinkPad detected, configuring fan control..."
    bash "$(dirname "$0")/thinkfan.sh"
fi

sudo apt-get autoremove -y
